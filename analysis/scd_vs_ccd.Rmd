---
title: Example in which the SCD and CCD updates produce the same sequence of iterates
author: Peter Carbonetto
output: workflowr::wflow_html
---

*Add text here.*

```{r knitr-opts, include=FALSE}
knitr::opts_chunk$set(comment = "#",collapse = TRUE,results = "hold",
                      fig.align = "center",dpi = 120)
```

Load the packages used in the analysis below.

```{r load-pkgs, message=FALSE}
library(R.matlab)
library(NNLM)
library(fastTopics)
```

Set the seed so that the results can be reproduced.

```{r set-seed}
set.seed(1)
```

Simulate a 100 x 200 counts matrix.

```{r sim-data}
X <- simulate_count_data(100,200,3)$X
```

*Add text here.*

```{r init-fit, results="hide", message=FALSE}
fit0 <- fit_poisson_nmf(X,k = 3,numiter = 20,method = "mu",
                        control = list(numiter = 1))
writeMat("../matlab/dat100x200.mat",X = X,L0 = fit0$L,F0 = fit0$F)
```

Run 40 multiplicative (EM) updates (as implemented in NNLM).

```{r fit-em}
fit1 <- suppressWarnings(nnmf(X,k = 3,init = list(W = fit0$L,H = t(fit0$F)),
                              method = "lee",loss = "mkl",max.iter = 40,
                              trace = 1,rel.tol = 0,inner.max.iter = 1,
                              inner.rel.tol = 0,n.threads = 1))
```

Run 40 SCD updates (as implemented in NNLM).

```{r fit-scd}
fit2 <- suppressWarnings(nnmf(X,k = 3,init = list(W = fit0$L,H = t(fit0$F)),
                              method = "scd",loss = "mkl",max.iter = 40,
                              trace = 1,rel.tol = 0,inner.max.iter = 1,
                              n.threads = 1))
```

Load the result of running 40 CCD updates on the same data set in MATLAB.

```{r fit-ccd}
fit3 <- readMat("../matlab/ccd100x200.mat")
fit3$obj <- drop(fit3$obj)
```

The estimates obtained after running the CCD and SCD updates are
nearly the same:

```{r scd-vs-ccd} 
print(range(fit2$W - fit3$W))
print(range(fit2$H - fit3$H))
```

Finally, I compare against SCD with extrapolation, as implemented in
fastTopics.

```{r fit-scd-ex, results="hide", message=FALSE}
fit4 <- fit_poisson_nmf(X,fit0 = fit0,numiter = 40,method = "scd",
                        control = list(extrapolate = TRUE,numiter = 1))
```

