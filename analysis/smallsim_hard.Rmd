---
title: Toy example comparing EM vs. SCD
author: Peter Carbonetto
output: workflowr::wflow_html
---

Here we perform a small experiment with simulated data to illustrate
the behaviour of the EM and SCD algorithms for fitting Poisson NMF
(and topic models). The basic variational EM algorithm for LDA also
struggles with this data set.

```{r knitr-opts, include=FALSE}
knitr::opts_chunk$set(comment = "#",collapse = TRUE,results = "hold",
                      fig.align = "center",dpi = 120)
```

Load the packages used in the analysis below, as well as some
additional functions used to simulate the data and generate the
results.

```{r load-pkgs, message=FALSE}
library(tm)
library(topicmodels)
library(fastTopics)
library(mvtnorm)
library(ggplot2)
library(cowplot)
source("../code/smallsim_functions.R")
```

Simulate a $100 \times 400$ counts matrix from a multinomial topic
model with $K = 6$ topics.

```{r sim-data, fig.height=1.5, fig.width=6, message=FALSE, warning=FALSE}
set.seed(2)
n <- 100
m <- 400
k <- 6
F <- simulate_factors(m,k)
out <- simulate_loadings(n,k)
L <- out$L
major_topic <- out$major_topic
s <- simulate_sizes(n)
X <- simulate_multinom_counts(L,F,s)
X <- X[,colSums(X > 0) > 0]
topic_colors <- c("dodgerblue","darkorange","forestgreen","darkblue",
                  "gold","skyblue")
simdata_structure_plot(L,major_topic,topic_colors)
```

ADD TEXT HERE.

```{r, eval=FALSE}
control <- list(extrapolate = FALSE,numiter = 4, eval=FALSE)
fit0 <- fit_poisson_nmf(X,k,numiter = 20,method = "em",control = control)
fit1 <- fit_poisson_nmf(X,fit0=fit0,numiter=180,method="em",control=control)
fit2 <- fit_poisson_nmf(X,fit0=fit0,numiter=80,method="scd",control=control)
control$extrapolate <- TRUE
fit2 <- fit_poisson_nmf(X,fit0=fit2,numiter=100,method="scd",control=control)
fit0 <- poisson2multinom(fit0)
fit1 <- poisson2multinom(fit1)
fit2 <- poisson2multinom(fit2)
print(loadings_scatterplot(fit1$L,fit2$L,topic_colors,"em","scd"))
```

```{r, eval=FALSE}
pdat <- rbind(data.frame(iter   = 1:200,
                         ll     = fit1$progress$loglik.multinom,
                         res    = fit1$progress$res,
                         method = "em"),
			  data.frame(iter   = 1:200,
			             ll     = fit2$progress$loglik.multinom,
						 res    = fit2$progress$res,
						 method = "scd"))
pdat <- transform(pdat,
                  ll   = max(ll) - ll + 0.1)
p <- ggplot(pdat,aes(x = iter,y = ll,color = method)) +
  geom_line(size = 0.75) +
  scale_y_continuous(trans = "log10") +
  scale_color_manual(values = c("dodgerblue","darkorange")) +
  labs(x = "iteration",y = "loglik difference") +
  theme_cowplot(font_size = 10)
print(p)
```

```{r, eval=FALSE}
p1 <- simdata_structure_plot(L,topic_colors)
p2 <- simdata_structure_plot(fit1$L,topic_colors)
p3 <- simdata_structure_plot(fit2$L,topic_colors)
plot_grid(p1,p2,p3,nrow = 3,ncol = 1)
```
