---
title: Toy example comparing EM vs. SCD
author: Peter Carbonetto
output: workflowr::wflow_html
---

Here we perform a small experiment with simulated data to illustrate
the behaviour of the EM and SCD algorithms for fitting Poisson NMF
(and topic models). The basic variational EM algorithm for LDA also
struggles with this data set.

```{r knitr-opts, include=FALSE}
knitr::opts_chunk$set(comment = "#",collapse = TRUE,results = "hold",
                      fig.align = "center",dpi = 120)
```

Load the packages used in the analysis below, as well as some
additional functions used to simulate the data and generate the
results.

```{r load-pkgs, message=FALSE}
library(tm)
library(topicmodels)
library(fastTopics)
library(mvtnorm)
library(ggplot2)
library(cowplot)
source("../code/smallsim_functions.R")
```

Simulate a $100 \times 400$ counts matrix from a multinomial topic
model with $K = 6$ topics.

```{r sim-data}
set.seed(4)
n <- 100
m <- 400
k <- 6
F <- simulate_factors(m,k)
out <- simulate_loadings(n,k)
L <- out$L
major_topic <- out$major_topic
s <- simulate_sizes(n)
X <- simulate_multinom_counts(L,F,s)
cols <- which(colSums(X > 0) > 0)
F <- F[cols,]
X <- X[,cols]
```

We fit the multinomial topic model by performing 80 EM updates or 80
SCD updates. Both of the fits were first initialized by running 20 EM
updates.

```{r fit-models, message=FALSE, results="hide"}
control <- list(extrapolate = FALSE,numiter = 4)
fit0 <- fit_poisson_nmf(X,k,numiter=20,method="em",control=control)
fit1 <- fit_poisson_nmf(X,fit0=fit0,numiter=80,method="em",control=control)
fit2 <- fit_poisson_nmf(X,fit0=fit0,numiter=80,method="scd",control=control)
```

EM and SCD produce quite different estimates, and among the two, the
SCD estimates are much closer to the truth.

```{r compare-fits, fig.height=4, fig.width=5, message=FALSE}
topic_colors <- c("dodgerblue","darkorange","forestgreen","darkblue",
                  "gold","skyblue")
loadings_order <- order(major_topic,L[,1])
k_set <- c(1,3,5,2,4,6)
p1 <- simdata_structure_plot(L,loadings_order,topic_colors,title = "true")
p2 <- simdata_structure_plot(poisson2multinom(fit1)$L,loadings_order,
                             topic_colors[k_set],title = "EM")
p3 <- simdata_structure_plot(poisson2multinom(fit2)$L,loadings_order,
                             topic_colors[k_set],title = "SCD")
plot_grid(p1,p2,p3,nrow = 3,ncol = 1)
```

Indeed, the SCD estimates also improve upon the EM estimates in terms
of log-likelihood, with a total improvement of 600 log-likelihood units,

```{r compare-logliks}
make_colvec(c("em" = sum(loglik_multinom_topic_model(X,fit1)),
              "scd" = sum(loglik_multinom_topic_model(X,fit2))))
```

or an average of 6 log-likelihood units per document,

```{r compare-logliks-2}
make_colvec(c("em" = sum(loglik_multinom_topic_model(X,fit1)),
              "scd" = sum(loglik_multinom_topic_model(X,fit2)))/n)
```

Let's now see how this relates to fitting an LDA model. Mention here
that we fix the prior (alpha), but estimating the prior complicates
the comparison (and explain why).

```{r run-lda}
lda0 <- LDA(X,k = 6,
            control = list(alpha = 1,estimate.alpha = FALSE,verbose = 0,
  					       em = list(iter.max = 100,tol = 0),
                           var = list(iter.max = 20,tol = 0),
                           keep = 1))
lda1 <- run_lda(X,fit1,numiter = 100)
lda2 <- run_lda(X,fit2,numiter = 100)
```

ADD TEXT HERE.

```{r compare-elbos}
make_colvec(c("default init" = logLik(lda0),
              "100 EM init" = logLik(lda1),
              "20 EM + 80 SCD" = logLik(lda2)))
```

NEXT: Show structure plots from the LDA results.

```{r compare-lda-fits, fig.height=5.5, fig.width=5, message=FALSE}
k_set_lda0 <- c(1,2,5,3,6,4)
p1 <- simdata_structure_plot(L,loadings_order,topic_colors,title = "true")
p2 <- simdata_structure_plot(lda0@gamma,loadings_order,
                             topic_colors[k_set_lda0],
							 title = "Default initialization")
p3 <- simdata_structure_plot(lda1@gamma,loadings_order,
                             topic_colors[k_set],
							 title = "Initialized with 100 EM updates")
p4 <- simdata_structure_plot(lda2@gamma,loadings_order,
                             topic_colors[k_set],
							 title = "Initialized with 20 EM + 80 SCD updates")
plot_grid(p1,p2,p3,p4,nrow = 4,ncol = 1)
```

ADD TEXT HERE.

```{r run-lda-longer}
lda0 <- LDA(X,k = 6,
            control = list(alpha = 1,estimate.alpha = FALSE,verbose = 0,
  					       em = list(iter.max = 800,tol = 0),
                           var = list(iter.max = 20,tol = 0),
                           keep = 1))
lda1 <- run_lda(X,fit1,numiter = 800)
lda2 <- run_lda(X,fit2,numiter = 800)
```

These plots show the improvement in the objective (the ELBO) over time.

```{r elbo-plot, fig.height=3, fig.width=3, eval=FALSE}
pdat <- rbind(data.frame(iter = 1:numiter,elbo = lda0@logLiks,init = "none"),
              data.frame(iter = 1:numiter,elbo = lda1@logLiks,init = "em"),
              data.frame(iter = 1:numiter,elbo = lda2@logLiks,init = "scd"))
pdat <- transform(pdat,elbo = elbo - max(elbo))
ggplot(pdat,aes(x = iter,y = elbo,color = init)) +
  geom_line(size = 0.75) +
  scale_color_manual(values=c("darkblue","dodgerblue","darkorange")) +
  labs(x = "iteration",y = "ELBO - max(ELBO)") +
  theme_cowplot(font_size = 10)
```

What is reassuring is that if we continue to perform the EM updates,
we eventually arrive at the same solution as SCD. But SCD is able to
"rescue" the EM estimates much more quickly after performing just a
few SCD updates.

```{r fit-models-2, message=FALSE, results="hide", fig.height=2.5, fig.width=3.5, eval=FALSE}
fit3 <- fit_poisson_nmf(X,fit0=fit1,numiter=700,method="em",control=control)
control$extrapolate <- TRUE
fit2 <- fit_poisson_nmf(X,fit0=fit2,numiter=700,method="scd",control=control)
fit4 <- fit_poisson_nmf(X,fit0=fit1,numiter=700,method="scd",control=control)
fit1 <- poisson2multinom(fit1)
fit2 <- poisson2multinom(fit2)
fit3 <- poisson2multinom(fit3)
fit4 <- poisson2multinom(fit4)
# loadings_scatterplot(F[,k_set],fit1$F,topic_colors,"true","em")
# loadings_scatterplot(F[,k_set],fit2$F,topic_colors,"true","scd")
pdat <- rbind(data.frame(iter   = 1:800,
			             ll     = fit2$progress$loglik.multinom,
						 method = "scd"),
              data.frame(iter   = 1:800,
                         ll     = fit3$progress$loglik.multinom,
                         method = "em"),
			  data.frame(iter   = 1:800,
			             ll     = fit4$progress$loglik.multinom,
			             method = "em+scd"))
pdat <- transform(pdat,ll = max(ll) - ll + 0.1)
ggplot(pdat,aes(x = iter,y = ll,color = method)) +
  geom_line(linewidth = 0.75) +
  scale_x_continuous(breaks = seq(0,800,100)) +
  scale_y_continuous(trans = "log10",breaks = 10^seq(-1,4)) +
  scale_color_manual(values = c("dodgerblue","darkorange","magenta")) +
  labs(x = "iteration",y = "loglik difference") +
  theme_cowplot(font_size = 10)
```

