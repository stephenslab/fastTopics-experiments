---
title: A small simulation illustrating the trouble with EM
author: Peter Carbonetto
output: workflowr::wflow_html
---

*Add text here.*

```{r knitr-opts, include=FALSE}
knitr::opts_chunk$set(comment = "#",collapse = TRUE,results = "hold",
                      fig.align = "center",dpi = 120)
```

Load the packages used in the analysis below, as well as additional
functions that we will use to simulate the data.

```{r load-pkgs, message=FALSE}
library(fastTopics)
library(mvtnorm)
library(ggplot2)
library(cowplot)
source("../code/smallsim_functions.R")
```

Set the seed so that the results can be reproduced.

```{r set-seed}
set.seed(1)
```

Independent topics scenario
---------------------------

In this first example, we simulate a $100 \times 400$ counts matrix
from a multinomial topic model with 6 topics.

```{r simulate-data-1}
n <- 100
m <- 400
k <- 6
S <- 13*diag(k) - 2
F <- simulate_factors(m,k)
L <- simulate_loadings(n,k,S)
s <- simulate_sizes(n)
X <- simulate_multinom_counts(L,F,s)
X <- X[,colSums(X > 0) > 0]
```

The topic proportions for each sample---*i.e.*, a row of the counts
matrix---are randomly drawn from the
[correlated topic model](https://doi.org/10.1214/07-AOAS114) in which
$\eta_i$ for each sample $i$ is drawn from the multivariate normal
with mean zero and covariance matrix $S$, such that $s_{kk} = 11$,
$s_{jk} = -2$ for all $j \neq k$. Generated in this way, the topic
proportions tend to be roughly *orthogonal*. For example, compare the
proportions for topics 5 and 6:

```{r plot-loadings-1, fig.width=3, fig.height=2.75}
ggplot(data.frame(x = L[,5],y = L[,6]),aes(x = x,y = y)) +
  geom_point(shape = 21,size = 1.75,color = "white",fill = "black") +
  labs(x = "topic 5 proportion",y = "topic 6 proportion") +
  theme_cowplot(font_size = 10)
```

We compare two different updates for fitting a Poisson NMF model to
the simulated counts: EM and sequential coordinate descent (SCD). We
initialize the model fitting by first running 50 EM updates to better
ensure that the same local maximum is recovered by both runs.

```{r fit-1, message=FALSE}
fit0 <- fit_poisson_nmf(X,k,numiter = 50,method = "em",
                        control = list(extrapolate = FALSE,numiter = 4))
fit1 <- fit_poisson_nmf(X,fit0 = fit0,numiter = 450,method = "em",
                        control = list(extrapolate = FALSE,numiter = 4))
fit2 <- fit_poisson_nmf(X,fit0 = fit0,numiter = 450,method = "scd",
                        control = list(extrapolate = FALSE,numiter = 4))
fit1 <- poisson2multinom(fit1)
fit2 <- poisson2multinom(fit2)
```

*Add text here.*

```{r plot-progress-1, fig.width=4, fig.height=3}
pdat <- rbind(data.frame(x=1:500,y=fit1$progress$loglik.multinom,method="em"),
              data.frame(x=1:500,y=fit2$progress$loglik.multinom,method="scd"))
pdat <- transform(pdat,y = max(y) - y + 0.01)
pdat <- subset(pdat,x > 50)
ggplot(pdat,aes(x = x,y = y,color = method)) +
  geom_line(size = 0.75) +
  scale_y_continuous(trans = "log10",breaks = 10^seq(-2,3)) +
  scale_color_manual(values = c("dodgerblue","darkorange")) +
  labs(x = "iteration",y = "distance from best loglik") +
  theme_cowplot(font_size = 10)
```

Correlated topics scenario
--------------------------

*Add text here.*

```{r simulate-data-2}
set.seed(1)
S[5,6] <- 10
S[6,5] <- 10
L <- simulate_loadings(n,k,S)
X <- simulate_multinom_counts(L,F,s)
X <- X[,colSums(X > 0) > 0]
```

TO DO: Plot mixture proportions for topics 5 and 6.

*Add text here.*

```{r fit-5, results="hide", message=FALSE}
fit0 <- fit_poisson_nmf(X,k,numiter = 50,method = "em",
                        control = list(extrapolate = FALSE,numiter = 4))
fit1 <- fit_poisson_nmf(X,fit0 = fit0,numiter = 800,method = "em",
                        control = list(extrapolate = FALSE,numiter = 4))
fit2 <- fit_poisson_nmf(X,fit0 = fit0,numiter = 1000,method = "scd",
                        control = list(extrapolate = FALSE,numiter = 4))
fit3 <- fit_poisson_nmf(X,fit0 = fit1,numiter = 200,method = "scd",
                        control = list(extrapolate = FALSE,numiter = 4))
fit1 <- fit_poisson_nmf(X,fit0 = fit1,numiter = 200,method = "scd",
                        control = list(extrapolate = FALSE,numiter = 4))
```

*Add text here.*

```{r plot-progress-2, fig.width=4, fig.height=3}
fit1 <- poisson2multinom(fit1)
fit2 <- poisson2multinom(fit2)
fit3 <- poisson2multinom(fit3)
plot_progress(list(em = fit1,scd = fit2,"scd+em" = fit3),
              x = "iter",add.point.every = 100)
```
